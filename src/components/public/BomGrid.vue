<template>
  <div class="r-grid">
    <!-- 没有选择物料 -->
    <template v-if="(!values || values.length == 0)&& cfg.allowEdit && hasDs">
      <div class="no-data-header" @click="showGridPicker">
        <div class="title">交易明细</div>
        <!--row-->
        <div>暂无数据</div>
        <div class="seleted_icon">
          请选择
          <span class="icon-right"></span>
        </div>
      </div>
    </template>
    <!-- 已经选择了物料 -->
    <template v-else>
      <div class="has-data-header">
        <div class="title">明细</div>
        <div v-if="(!values || values.length == 0)">暂无数据</div>
        <div @click="toggleEditStatus" v-if="cfg.allowEdit && values && values.length">
          <div class="edit" v-if="!isEdit">管理</div>
          <div class="edit" v-else>完成</div>
        </div>
      </div>
    </template>

    <div class="r-row-ct">
      <div
        class="r-row"
        v-for="(row,rIndex) in values"
        :key="rIndex"
        :class="{row_delete : isEdit,'vux-1px-b' : rIndex < values.length - 1 }">
        
        <div class="edit-btn-wrapper">
         <span class="icon-matter-bianji" @click.stop="onShowDetail(row,rIndex)" v-show="!isEdit && cfg.allowEdit"></span>
        </div>

        <div class="trans-item">
          <div class="trans-item-img">
            <img  :src="getImgPic(row)" >
          </div>
         
          <div class="trans-item-info">
            <template v-for="(item, index) in keyFiled" class="cell when-is-right">
              <div class="" v-if="item.kField" :key="'keyFiled' + index" >
                <span>{{item.text}}:</span>
                <span   v-if="item.editorType=='r2Percentfield'">{{formatByType(row[item.fieldCode],item.editorType)}}%</span>
                <span v-else  >{{formatByType(row[item.fieldCode],item.editorType)}}</span>
              </div>
            </template>

          </div>
        </div>

        <div @click.stop="onShowDetail(row,rIndex)" class="show-more" v-show="!isEdit && !cfg.allowEdit">
          其他
          <i class="icon-more"></i>
        </div>

        <div class="delete_icon" @click="delClick(rIndex)" v-if="isEdit">
          <x-icon type="ios-checkmark" size="20" class="checked" v-show="isChecked(rIndex)"></x-icon>
          <x-icon type="ios-circle-outline" size="20" v-show="!isChecked(rIndex)"></x-icon>
        </div>
        
      </div>
      <div class="summary-info" v-if="(values && values.length > 1)">
        <div class="summarry-info-count">共{{this.values.length}}条明细</div>
         <div>
            <template v-for="(item, index) in summaryField" >
              <div class="summary-item" v-if="item.hidden == false" :key="index">
                <span class="summary-item-label">{{item.text}}：</span>
                <span class="summary-item-value">{{formatByType(summaryValue[item.fieldCode],item.editorType)}}</span>
              </div>
            </template>
         </div>
      </div>
    </div>
    
    <div
      class="add-more-wrapper"
      v-if="cfg.allowEdit && ((values &&values.length) ||!hasDs) && !isEdit"
    >
      <div class="add-more" @click="addRecord">
        <span class="icon-add"></span>
        <span class="add_text">新增</span>
      </div>
    </div>

    <bom-grid-picker v-if="cfg.allowEdit && hasDs" ref="gridPicker" @on-select="addRecords"/>
    <div class="grid-detail-wrapper" v-if="showDetail">
      <grid-detail v-model="showDetail" @on-confirm="doDetailEdit" ref="gridDetail"/>
    </div>
    <div class="count_mode grid-manger-wrapper vux-1px-t" :class="{btn_hide : btnIsHide}" v-show="isEdit" v-transfer-dom>
      <div class="count_num all_checked" @click="checkAll">
        <x-icon type="ios-circle-outline" size="20" class="outline" v-show="!isCheckAll()"></x-icon>
        <x-icon type="ios-checkmark" size="20" class="checked" v-show="isCheckAll()"></x-icon>全选
      </div>
      <div class="delete_btn" @click="doDelete">删除</div>
    </div>
    <!-- bom明细 -->
    <div class="materiel_list work_list" v-show="boms.length">
      <bom-list :boms="bomList">
        <template slot-scope="{bom}" slot="specification">
          <div class="content-unit">
            <span>计量单位: {{bom.measureUnit}}</span>
            <span>物料属性: {{bom.processing}}</span>
            <span>获取方式: {{bom.productSource}}</span>
          </div>
        </template>
        <template slot-scope="{bom}" slot="number">
          <div class="number-part">
            <span class="main-number">bom需求: {{bom.demandQty || 0}}</span>
            <span class="number-unit">在库余额: {{bom.thenTotalQtyStock||0}}</span>
            <span class="number-unit">在途余额: {{bom.transitBalance||0}}</span>
            <span class="number-unit">领料需求: {{bom.tdQty||0}}</span>
          </div>
        </template>
      </bom-list>
    </div>
  </div>
  <!--grid-->
</template>



<script>
import Vue from "vue";
import dao from "plugins/ajax";
import bomGridPicker from "./BomGridPicker";
import girdMix from "mixins/bomgrid";
import objList from '../../common/const/obj-app';
import BomList from 'components/detail/commonPart/BomList'
var component = {
  mixins: [girdMix],
  components: { bomGridPicker,BomList },
  props: ["cfg", "values", "btnIsHide"],
  computed:{
    curObj:function() {
      if(!this.values || this.values.length < 1) return;
      let fieldSettingData = JSON.parse(window.sessionStorage.getItem('r2FieldSetting'))||this.$r2FieldSetting,
        obj,
        objKey,
        fKey;

      this.keyFiled.map(it=>{
          objKey = it.fieldCode.indexOf('_') > -1 ? it.fieldCode.split('_')[1] : it.fieldCode;
          fKey = it.fieldCode.split('_')[0];

          if(fieldSettingData&&fieldSettingData[objKey]){
              if(fieldSettingData[objKey]['objCode']){
                  obj = objList.getObjectByName(fieldSettingData[objKey]['objCode'])[0];
              }
          }
          if(fieldSettingData&&fieldSettingData[fKey]){
            
              if(fieldSettingData&&fieldSettingData[fKey]['kField']===1){
                  it.kField = 1;
              }
          }
      });
    },
    summaryValue:function(){
      let val = {};
      this.summaryField.map(it=>{
        this.values.map(d=>{
          if(val[it.fieldCode]){
            (val[it.fieldCode] += Number(d[it.fieldCode]));
          }else{
            val[it.fieldCode] = Number(d[it.fieldCode]);
          }
        });
      });

      for(var k in val){
        if(isNaN(val[k])){
          val[k] = '无';
        }else{
          val[k] = val[k].toFixed(2)
        }
      }
      return val;
    },
    bomList: {
      get: function(){
        return this.boms; // 在这里把临时对象的值通过计算属性赋值给页面中用到的对象
      }
    },
  },
  data() {
    return {
      showDetail: false,
      detail: {},
      hasDs:false,
      notAddOneRow:false,
      keyFiled:{},
      bomFiled:[],
    };
  },
  watch:{
    values:{
      handler(val){
        if(this.form.formData.outPut&&this.form.model!='new'){
          this.boms = [];
          var data = this.form.formData.outPut;
          for(var i = 0 ; i < data.length; i++){
            var arr = {
              ...data[i],
              inventoryCode:  data[i].outPutMatCode,
              inventoryName:  data[i].inventoryName_outPutMatCode,
              measureUnit: data[i].measureUnit_outPutMatCode,
              processing: data[i].tdProcessing,
              productSource:  data[i].productSource,
              demandQty:  data[i].demandQty,
              thenTotalQtyStock:  data[i].thenTotalQtyStock,
              transitBalance: data[i].transitBalance,
              tdQty:  data[i].tdQty,
            }
            this.boms.push(arr)
          }
          //this.boms = this.form.formData.outPut;
        }
      }
    },
    boms:{
      handler(val){
        console.log('bonsm',val)
      }
    }
  },
  methods: {
    //选择默认图片
    getImgPic(d) {
       let url;
      if(d){
        let pic = this.curObj ? this.curObj.picKey : '',
            defaultUrl = this.curObj ? this.curObj.defaultUrl : 'wl_default03.png';
        url =  d[pic] ? d[pic] : '/static/' + defaultUrl;
      }else{
        url = require('assets/wl_default03.png');
      }
     return url;
    },
    checkAmt() {},
    setValue: function(value) {
      this.$set(this.form.formData, this.name, value);
      this.$set(this.form.formData, 'outPut', this.outPut);
      this.$event.$emit(`item-event-${this.name}`,value);
    },
    getValue: function() {
      return this.form.formData[this.name];
    },
    hasDataSource: function(cfg) {
      return cfg.xtype != "r2Grid" && cfg.xtype!='r2AutoLoadGrid';
    },
    showGridPicker() {
      this.$refs.gridPicker.show();
    },
    initDataSource(cfg) {
      var me = this;
      
      me.dataSource = me.hasDataSource(cfg)
        ? //适配 r2AccountGrid
          cfg.dataSource
        : findDs(cfg.columns);
      me.hasDs = !!me.dataSource;

      function findDs(columns) {
        var i = 0,
          l = columns.length,
          col;

        for (i; i < l; i++) {
          col = columns[i];
          if (~["r2Selector", "r2SelectorPlus"].indexOf(col.editorType)) {
            me.dataSourceBind = { k: col.fieldCode, v: col.valueField };
            if(col.dataSource && me.cfg.xtype!=='r2AutoLoadGrid') {
              col.dataSource.data.cols = col.proertyContext.dataSourceCols;
              return col.dataSource.data;
            }

            if(me.cfg.xtype=='r2AutoLoadGrid'){
              return {
                ...me.cfg.dataSource.data,
                cols:me.cfg.proertyContext
              }
            }
          }
        }
      }
    },  
    onShowDetail(row, rowIndex) {
      this.detail = row;
      this.detailRowNumer = rowIndex;
      this.showDetail = true;
    },
    async initKeyFiled(){
      await this.load();
      //await this.dealKeyFiled();
    },
    dealKeyFiled(){
      let fieldSettingData = JSON.parse(window.sessionStorage.getItem('r2FieldSetting'))||this.$r2FieldSetting,
        obj,
        objKey,
        fKey;
      
      this.bomFiled = this.bomFiled.map(function(it,index,arr) {
          objKey = it.v.indexOf('_') > -1 ? it.v.split('_')[1] : it.v;
          fKey = it.v.split('_')[0];

          if(fieldSettingData&&fieldSettingData[objKey]){
              if(fieldSettingData[objKey]['objCode']){
                  obj = objList.getObjectByName(fieldSettingData[objKey]['objCode'])[0];
              }
          }
          if(fieldSettingData&&fieldSettingData[fKey]){
            
              if(fieldSettingData&&fieldSettingData[fKey]['kField']===1){
                  it.kField = 1;
              }
          }
          return it;
      },this);
    }
  },
  created() {
    var cfg = this.cfg,
      id = cfg.id,
      fieldSet = this.$parent,
      form = fieldSet.form,
      values = this.values,
      name = fieldSet.name,
      notAddOneRow = this.cfg.notAddOneRow;
    
    this.keyFiled = this.cfg.columns.filter(it=>{
      return !it.hidden;
    });
    //暂时不清楚bom的字段名称从哪里取，导致dealKeyFiled函数不知道从哪里取中文？关键字段取貌似对不上，疑似pc端写死
    // for(var item in this.cfg.bomDataIndexMap){
    //   var data = {
    //     k: this.cfg.bomDataIndexMap[item],
    //     v: item,
    //   }
    //   this.bomFiled.push(data);
    // }
    this.initKeyFiled();

    this.summaryField = this.cfg.columns.filter(it=>{
      return !it.hidden;
    }).filter((it)=>{
      return ['r2Numberfield','r2Percentfield '].includes(it.editorType) && it.summaryType === 'sum';
    });

    form.fieldMap[id] = this;
    form.fields[this.cfg.fieldCode] = this;
    this.isGrid = true;
    this.name = name;
    this.form = form;
    this.containerCode = fieldSet.cfg.name;
    this.dao = dao;//执行公式用;
    this.initDataSource(cfg);
    this.initDefaultValueCfg();
    this.initValueBindAndExpressionCfg();
    this.initEditorParamsCfg();
    if(this.cfg.notAddOneRow==false){
      var value = this.getValue() || [],
        record,
        row, i = 0;

      record = this.createRecord();
      value.push(record.data);
      this.setValue(value);
    }
    if(this.cfg.allowAddorDel==false){
      var value = this.getValue() || [],
        record,
        row, i = 0;

      record = this.createRecord();
      value.push(record.data);
      this.setValue(value);
    }
  }
};
export default Vue.component("BomGrid", component);
</script>

<style lang="scss">

.row_delete {
  position: relative;
  padding-left: 0.3rem;
}
.delete_icon {
  left: 0;
  top: 50%;
  height: 20px;
  fill: #999;
  position: absolute;
  transform: translateY(-50%);
  .checked {
    fill: #fa7138;
  }
}
.no-data{
  text-align:center;
}
.r-grid {
  // 没有物料title样式
  .no-data-header {
    display: flex;
    padding: 0.15rem 0;
    font-size: 0.14rem;
    line-height: 0.14rem;
    justify-content: space-between;
    .title {
      @include font_color();
      font-weight: bold;
    }
    .seleted_icon {
      display: flex;
      align-items: center;
      .icon-right {
        width: 0.08rem;
        height: 0.14rem;
        margin-left: 0.1rem;
      }
    }
  }
  // 有物料的title的样式
  .has-data-header {
    display: flex;
    padding: 0.2rem 0 0.1rem;
    border-bottom:1px solid #eee;
    line-height: 0.14rem;
    justify-content: space-between;
    .title {
      color: #696969;
    }
    .edit {
      @include font_color();
    }
  }
  //明细数据容器
  .r-row-ct{
    .r-row {
      margin: 0.05rem 0 0.05rem;
      line-height: 0.20rem;
      font-size: 0.12rem;

      .trans-item{
        display: flex;
        .trans-item-img{
          img{
            width: 0.85rem;
          }
        }
        .trans-item-info{
          margin-left: 0.05rem;

          .summary-item{
            display: flex;
            justify-content: space-between;

            .summary-item-value{
              color: #4CA3FB;
              font-weight: bold;
            }
          }
        }
      }
      span:nth-child(2n + 1) {
        color: #aaa;
      }
      span:nth-child(2n) {
        font-weight: 400;
        font-size: 0.13rem;
      }
      &.vux-1px-b:after {
        border-color: #e8e8e8;
      }
      &.vux-1px-b:last-child:after {
        border: none;
      }
      .edit-btn-wrapper{
        position: relative;
      }
      .icon-matter-bianji {
        width: .28rem;
        height: .28rem;
        position: absolute;
        right: 0;
        top: .03rem;
      }
      .show-more {
        text-align: right;
        height: 0.25rem;
        line-height: 0.25rem;
        font-size: .14rem;
        @include font_color();
        .icon-more {
          display: inline-block;
          width: 0.2rem;
          height: 0.04rem;
        }
      }
      .item {
        display: inline-flex;
        margin-right: 0.05rem;
      }
    }
    .summary-info{
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 600;
      border-top: 1px solid #ddd;
      padding: 0.05rem 0rem;
      color:#605a5a;
      .summary-item{
        display: flex;
        justify-content: space-between;

        .summary-item-label{

        }

        .summary-item-value{
          color: #4CA3FB;
        }

      }
    }
  }
  .add-more-wrapper {
    width: 100%;
    display: flex;
    text-align: center;
    position: relative;
  }
  .add-more {
    display: flex;
    @include font_color();
    font-weight: bold;
    text-align: center;
    align-items: center;
    margin: 0 auto 0.2rem;
    border-radius: 0.15rem;
    padding: 0.06rem 0.08rem;
    border: 1px solid;
    @include boder_color();
    .icon-add {
      width: 0.14rem;
      height: 0.14rem;
      margin-right: 0.05rem;
      box-sizing: border-box;
    }
    .add_text {
      font-size: 0.12rem;
      line-height: 0.12rem;
    }
  }
  
}
.grid-manger-wrapper {
  z-index: 100;
}

</style>